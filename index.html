<html>
<head>
    <title>Buckets of Fun</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: #ffffff;
            margin: 0;
            overflow: hidden;
            font-family: arial;
        }

        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        #instructions {
            width: 100%;
            height: 100%;
            display: -webkit-box;
            display: -moz-box;
            display: box;
            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;
            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;
            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;
            color: #ffffff;
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <script src="three.js"></script>
    <script src="PointerLockControls.js"></script>
    <div id="blocker">
        <div id="instructions">
            <span style="font-size: 40px">Click to play</span>
            <br />
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
        </div>
    </div>
    <script>

        var camera, scene, renderer, listener;
        var geometry, wallMaterial, floorMaterial, ceilingMaterial, bucketMaterial;
        var controls;

        var floorMesh, ceilingMesh, mrBucket;

        var wallMap;

        var blocker = document.getElementById('blocker');
        var instructions = document.getElementById('instructions');

        var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;
        if (havePointerLock) {
            var element = document.body;
            var pointerlockchange = function (event) {
                if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
                    controlsEnabled = true;
                    controls.enabled = true;
                    blocker.style.display = 'none';
                } else {
                    controls.enabled = false;
                    blocker.style.display = '-webkit-box';
                    blocker.style.display = '-moz-box';
                    blocker.style.display = 'box';
                    instructions.style.display = '';
                }
            }
            var pointerlockerror = function (event) {
                instructions.style.display = '';
            }
            // Hook pointer lock state change events
            document.addEventListener('pointerlockchange', pointerlockchange, false);
            document.addEventListener('mozpointerlockchange', pointerlockchange, false);
            document.addEventListener('webkitpointerlockchange', pointerlockchange, false);
            document.addEventListener('pointerlockerror', pointerlockerror, false);
            document.addEventListener('mozpointerlockerror', pointerlockerror, false);
            document.addEventListener('webkitpointerlockerror', pointerlockerror, false);
            instructions.addEventListener('click', function (event) {
                instructions.style.display = 'none';
                // Ask the browser to lock the pointer
                element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
                if (/Firefox/i.test(navigator.userAgent)) {
                    var fullscreenchange = function (event) {
                        if (document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element) {
                            document.removeEventListener('fullscreenchange', fullscreenchange);
                            document.removeEventListener('mozfullscreenchange', fullscreenchange);
                            element.requestPointerLock();
                        }
                    }
                    document.addEventListener('fullscreenchange', fullscreenchange, false);
                    document.addEventListener('mozfullscreenchange', fullscreenchange, false);
                    element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;
                    element.requestFullscreen();
                } else {
                    element.requestPointerLock();
                }
            }, false);
        } else {
            instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';
        }

        init();
        animate();

        var controlsEnabled = false;

        var moveForward = false;
        var moveBackward = false;
        var moveLeft = false;
        var moveRight = false;

        var prevTime = performance.now();
        var velocity = new THREE.Vector3();

        function init() {
            var mapWidth = 16;
            var mapHeight = 16;
            wallMap = [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            ];

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            var flashlight = new THREE.SpotLight(0xffffff, 2, 10, Math.PI / 2, 30);
            camera.add(flashlight);
            flashlight.position.set(0, 0, 1);
            flashlight.target = camera;

            scene = new THREE.Scene();

            controls = new THREE.PointerLockControls(camera);
            scene.add(controls.getObject());

            var onKeyDown = function (event) {
                switch (event.keyCode) {
                    case 38: // up
                    case 87: // w
                        moveForward = true;
                        break;
                    case 37: // left
                    case 65: // a
                        moveLeft = true; break;
                    case 40: // down
                    case 83: // s
                        moveBackward = true;
                        break;
                    case 39: // right
                    case 68: // d
                        moveRight = true;
                        break;
                }
            };

            var onKeyUp = function (event) {
                switch (event.keyCode) {
                    case 38: // up
                    case 87: // w
                        moveForward = false;
                        break;
                    case 37: // left
                    case 65: // a
                        moveLeft = false;
                        break;
                    case 40: // down
                    case 83: // s
                        moveBackward = false;
                        break;
                    case 39: // right
                    case 68: // d
                        moveRight = false;
                        break;
                }
            };

            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);

            geometry = new THREE.BoxGeometry(1, 1, 1);
            var wallTexture = THREE.ImageUtils.loadTexture("Textures/WallTexture.png");
            wallTexture.minFilter = wallTexture.magFilter = THREE.NearestFilter;
            wallMaterial = new THREE.MeshPhongMaterial({ map: wallTexture, shininess: 5 });

            var bucketTexture = THREE.ImageUtils.loadTexture("Textures/MisterBucket.png");
            bucketTexture.minFilter = bucketTexture.magFilter = THREE.NearestFilter;
            bucketMaterial = new THREE.SpriteMaterial({ map: bucketTexture });

            for (var x = 0; x < mapWidth; x++) {
                for (var z = 0; z < mapHeight; z++) {
                    var middleX = x + 0.5;
                    var middleZ = z + 0.5;
                    var wallType = wallMap[x][z];
                    if (wallType === 1) {
                        var cube = new THREE.Mesh(geometry, wallMaterial);
                        cube.position.set(middleX, 0.5, middleZ);
                        scene.add(cube);
                    } else if (wallType === 2) {
                        mrBucket = new THREE.Sprite(bucketMaterial);
                        mrBucket.position.set(middleX, 0.5, middleZ);
                        scene.add(mrBucket);
                    } else if (wallType === 9) {
                        controls.getObject().position.set(middleX, 0.5, middleZ);
                    }
                }
            }

            geometry = new THREE.PlaneGeometry(32, 32, 1, 1);
            geometry.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI / 2));
            var floorTexture = THREE.ImageUtils.loadTexture("Textures/FloorTexture.png");
            floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
            floorTexture.repeat.x = floorTexture.repeat.y = 32;
            floorTexture.minFilter = floorTexture.magFilter = THREE.NearestFilter;
            floorMaterial = new THREE.MeshPhongMaterial({ map: floorTexture, shininess: 5 });
            floorMesh = new THREE.Mesh(geometry, floorMaterial);
            scene.add(floorMesh);

            geometry = new THREE.PlaneGeometry(32, 32, 1, 1);
            geometry.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI / 2));
            var ceilingTexture = THREE.ImageUtils.loadTexture("Textures/CeilingTexture.png");
            ceilingTexture.wrapS = ceilingTexture.wrapT = THREE.RepeatWrapping;
            ceilingTexture.repeat.x = ceilingTexture.repeat.y = 32;
            ceilingTexture.minFilter = ceilingTexture.magFilter = THREE.NearestFilter;
            ceilingMaterial = new THREE.MeshPhongMaterial({ map: ceilingTexture, shininess: 5 });
            ceilingMesh = new THREE.Mesh(geometry, ceilingMaterial);
            ceilingMesh.translateY(1);
            scene.add(ceilingMesh);

            listener = new THREE.AudioListener();
            camera.add(listener);

            var bucketStrolling = new THREE.Audio(listener);
            bucketStrolling.load("Sounds/Mr Bucket strolling.wav");
            bucketStrolling.setRefDistance(1);
            bucketStrolling.setLoop(true);
            mrBucket.add(bucketStrolling);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', onWindowResize, false);
        }


        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }


        function animate() {
            requestAnimationFrame(animate);

            if (controlsEnabled) {
                var time = performance.now();
                var delta = (time - prevTime) / 1000;

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                if (moveForward) velocity.z -= 20.0 * delta;
                if (moveBackward) velocity.z += 20.0 * delta;
                if (moveLeft) velocity.x -= 20.0 * delta;
                if (moveRight) velocity.x += 20.0 * delta;

                var previousX = controls.getObject().position.x;
                controls.getObject().translateX(velocity.x * delta);
                var newX = controls.getObject().position.x;
                var previousZ = controls.getObject().position.z;
                controls.getObject().translateZ(velocity.z * delta);
                var newZ = controls.getObject().position.z;

                if (wallMap[Math.floor(newX)][Math.floor(previousZ)] === 1) {
                    controls.getObject().position.x = previousX;
                }
                if (wallMap[Math.floor(previousX)][Math.floor(newZ)] === 1) {
                    controls.getObject().position.z = previousZ;
                }

                var positionDifference = new THREE.Vector3();
                positionDifference.subVectors(controls.getObject().position, mrBucket.position);
                positionDifference.normalize();
                positionDifference.multiplyScalar(0.2 * delta);
                mrBucket.position.add(positionDifference);

                prevTime = time;
            }

            floorMesh.position.x = ceilingMesh.position.x = Math.floor(controls.getObject().position.x);
            floorMesh.position.z = ceilingMesh.position.z = Math.floor(controls.getObject().position.z);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
