{"version":3,"sources":["webglManager.ts"],"names":[],"mappings":"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","file":"webglManager.js","sourcesContent":["import * as twgl from \"twgl\";\r\n\r\nimport {Init, Draw} from \"./animationManager\";\r\nimport * as ces from \"./ces\";\r\nimport {isCamera} from \"./cameraManager\";\r\nimport {isCollidable, getCorners} from \"./collisionManager\";\r\nimport {spliceArray, Point} from \"./utils\";\r\n\r\nimport {CombinedEntity} from \"./entity\";\r\n\r\nconst debug = false;\r\nconst obj: any = {};\r\n\r\nexport let canvasDimensions: Point = {x: 1000, y: 750, z: 1};\r\nexport let visibleDimensions: Point = {x: 0, y: 0, z: 1};\r\n\r\nexport interface Color {\r\n  h?: number;\r\n  s?: number;\r\n  v?: number;\r\n  r?: number;\r\n  g?: number;\r\n  b?: number;\r\n  a?: number;\r\n}\r\n\r\nexport interface Entity {\r\n  texture: string;\r\n  position: Point;\r\n  dimensions: Point;\r\n  center?: Point;\r\n  scale?: number;\r\n  rotation?: number;\r\n  color?: Color;\r\n}\r\nexport function isRenderable(entity: CombinedEntity): entity is Entity { return \"texture\" in entity; }\r\n\r\nfunction positionCanvas(canvas: HTMLCanvasElement, gl: WebGLRenderingContext) {\r\n  if (window.innerWidth > window.innerHeight) {\r\n    let visibleHeight = window.innerHeight - 100;\r\n    let visibleWidth = visibleHeight * 4 / 3;\r\n    visibleDimensions = {x: visibleWidth, y: visibleHeight, z: 0};\r\n  } else {\r\n    let visibleWidth = window.innerWidth - 100;\r\n    let visibleHeight = visibleWidth * 3 / 4;\r\n    visibleDimensions = {x: visibleWidth, y: visibleHeight, z: 0};\r\n  }\r\n\r\n  canvas.style.width = visibleDimensions.x + \"px\";\r\n  canvas.style.height = visibleDimensions.y + \"px\";\r\n  canvas.style.marginLeft = -visibleDimensions.x / 2 + \"px\";\r\n  canvas.style.marginTop = -visibleDimensions.y / 2 + \"px\";\r\n  canvas.width = canvasDimensions.x;\r\n  canvas.height = canvasDimensions.y;\r\n  gl.viewport(0, 0, canvasDimensions.x, canvasDimensions.y);\r\n}\r\n\r\nasync function fetchShader(path: string) {\r\n  let result = await fetch(path);\r\n  return await result.text();\r\n}\r\n\r\ninterface TextureInfo {\r\n  size: number,\r\n  canvas: HTMLCanvasElement,\r\n  texCoords: { [id: string]: number[] },\r\n  texture?: WebGLTexture\r\n}\r\n\r\nfunction packTextures(images: { [id: string]: HTMLImageElement }): TextureInfo {\r\n  let imageArray: {image: HTMLImageElement, id: string}[] = [];\r\n  for (let id in images) {\r\n    imageArray.push({image: images[id], id: id});\r\n  }\r\n  imageArray = imageArray.sort((a, b) => a.image.height - b.image.height);\r\n  let size = 16;\r\n  let correctSize = true;\r\n  do {\r\n    correctSize = true;\r\n    size *= 2;\r\n    let x = 0;\r\n    let y = 0;\r\n    let rowHeight = imageArray[0].image.height;\r\n    for (let imageData of imageArray) {\r\n      let image = imageData.image;\r\n      x += image.width + 2;\r\n      if (x > size) {\r\n        x = 0;\r\n        y += rowHeight + 2;\r\n        if (y + image.height > size) {\r\n          correctSize = false;\r\n          break;\r\n        }\r\n        rowHeight = image.height;\r\n      }\r\n    }\r\n  } while (!correctSize)\r\n\r\n  let canvas = document.createElement('canvas');\r\n  canvas.width = size;\r\n  canvas.height = size;\r\n  let ctx = canvas.getContext('2d');\r\n  let x = 0;\r\n  let y = 0;\r\n  let rowHeight = imageArray[0].image.height;\r\n  let imageLayoutInfo: { [id: string]: number[] } = {};\r\n  for (let imageData of imageArray) {\r\n    let image = imageData.image;\r\n    if (x + image.width > size) {\r\n      x = 0;\r\n      y += rowHeight + 2;\r\n      rowHeight = image.height;\r\n    }\r\n    ctx.drawImage(image, x, y);\r\n    imageLayoutInfo[imageData.id] = [\r\n      x, y,\r\n      x + image.width, y,\r\n      x, y + image.height,\r\n      x + image.width, y + image.height\r\n    ];\r\n    x += image.width + 2;\r\n  }\r\n  return {size: size, canvas: canvas, texCoords: imageLayoutInfo};\r\n}\r\n\r\nasync function loadTextures(basePath: string, texturePaths: string[]) {\r\n  let images: { [id: string]: HTMLImageElement } = {};\r\n  for (let path of texturePaths) {\r\n    let imagePath = basePath + \"assets/Images/\" + path;\r\n    let image = new Image();\r\n    let loadedPromise = new Promise((resolve) => {\r\n      let handler = () => {\r\n        resolve();\r\n        image.removeEventListener('load', handler);\r\n      }\r\n      image.addEventListener('load', handler, false);\r\n      image.src = imagePath;\r\n    });\r\n    await loadedPromise;\r\n    images[path] = image;\r\n  }\r\n\r\n  return packTextures(images);\r\n}\r\n\r\nasync function setupTextures(gl: WebGLRenderingContext, basePath: string, texturePaths: string[]) {\r\n  let result = await loadTextures(basePath, texturePaths);\r\n  // document.body.appendChild(result.canvas);\r\n  let texture = twgl.createTexture(gl, {\r\n    src: result.canvas,\r\n    // wrap: gl.CLAMP_TO_EDGE,\r\n    // mag: gl.NEAREST,\r\n    // min: gl.NEAREST\r\n  });\r\n\r\n  return {texture: texture, ...result};\r\n}\r\n\r\nasync function compileProgram(gl: WebGLRenderingContext, basePath: string, folder: string) {\r\n  return twgl.createProgramInfo(gl, [\r\n    await fetchShader(basePath + \"assets/Shaders/\" + folder + \"/vert.glsl\"),\r\n    await fetchShader(basePath + \"assets/Shaders/\" + folder + \"/frag.glsl\")\r\n  ]);\r\n}\r\n\r\nfunction setCameraUniforms(program: twgl.ProgramInfo) {\r\n  let camera = ces.getEntities(isCamera)[0];\r\n  let cameraWidth = (camera.dimensions || obj).x || 100;\r\n  let cameraHeight = (camera.dimensions || obj).y || 100;\r\n\r\n  let cameraUniforms = {\r\n    u_camera_dimensions: [camera.position.x, camera.position.y, cameraWidth, cameraHeight]\r\n  };\r\n  twgl.setUniforms(program, cameraUniforms);\r\n\r\n}\r\n\r\nfunction clearCanvas(gl: WebGLRenderingContext, canvas: HTMLCanvasElement) {\r\n  positionCanvas(canvas, gl);\r\n  gl.clearColor(1, 1, 1, 1);\r\n  gl.clear(gl.COLOR_BUFFER_BIT);\r\n  gl.enable(gl.BLEND);\r\n  gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n}\r\n\r\nfunction spliceData(array: {numComponents: number, data: number[]}, entityIndex: number, data: number[]) {\r\n  let expectedCount = array.numComponents * 4;\r\n  for (let i = 0; i < expectedCount; i += data.length) {\r\n    spliceArray(array.data, entityIndex * expectedCount + i, data);\r\n  }\r\n}\r\n\r\nlet spriteArrays: {[id: string]: {numComponents: number, data: number[]}} = {\r\n  a_coord: {numComponents: 2, data: new Array(400)},\r\n  a_position: {numComponents: 3, data: new Array(400)},\r\n  a_texcoord: {numComponents: 2, data: new Array(400)},\r\n  a_rotation: {numComponents: 1, data: new Array(400)},\r\n  a_dimensions: {numComponents: 2, data: new Array(400)},\r\n  a_center: {numComponents: 2, data: new Array(400)},\r\n  a_scale: {numComponents: 1, data: new Array(400)},\r\n  indices: {numComponents: 3, data: new Array(400)}\r\n};\r\n\r\nfunction drawSprites(gl: WebGLRenderingContext, spriteProgram: twgl.ProgramInfo, textureInfo: TextureInfo) {\r\n  gl.useProgram(spriteProgram.program);\r\n  let renderables = ces.getEntities(isRenderable).sort((a, b) => (a.position.z || 0) - (b.position.z || 0));\r\n\r\n  for (let id in spriteArrays) {\r\n    let expectedLength = renderables.length * spriteArrays[id].numComponents;\r\n    if (spriteArrays[id].data.length < expectedLength) {\r\n      spriteArrays[id].data = new Array(expectedLength);\r\n    }\r\n  }\r\n\r\n  let index = 0;\r\n  for (let entity of renderables) {\r\n    spliceData(spriteArrays.a_coord, index, [ 0, 0, 1, 0, 0, 1, 1, 1 ]);\r\n    spliceData(spriteArrays.a_position, index, [\r\n      entity.position.x,\r\n      entity.position.y,\r\n      entity.position.z || 0\r\n    ]);\r\n    spliceData(spriteArrays.a_texcoord, index, textureInfo.texCoords[entity.texture]);\r\n    spliceData(spriteArrays.a_rotation, index, [entity.rotation || 0]);\r\n    spliceData(spriteArrays.a_dimensions, index, [\r\n      entity.dimensions.x,\r\n      entity.dimensions.y\r\n    ]);\r\n    spliceData(spriteArrays.a_center, index, [\r\n      (entity.center || obj).x || 0.5,\r\n      (entity.center || obj).y || 0.5\r\n    ]);\r\n    spliceData(spriteArrays.a_scale, index, [entity.scale || 1]);\r\n    let offset = index * 4;\r\n    spliceArray(spriteArrays.indices.data, index * 6,\r\n                [offset + 0, offset + 1, offset + 2, offset + 2, offset + 1, offset + 3]);\r\n    index++;\r\n  }\r\n\r\n  let bufferInfo = twgl.createBufferInfoFromArrays(gl, spriteArrays);\r\n  twgl.setBuffersAndAttributes(gl, spriteProgram, bufferInfo);\r\n  twgl.drawBufferInfo(gl, gl.TRIANGLES, bufferInfo, renderables.length * 6);\r\n}\r\n\r\nfunction drawDebug(gl: WebGLRenderingContext, debugProgram: twgl.ProgramInfo) {\r\n  gl.useProgram(debugProgram.program);\r\n\r\n  let indexOffset = 0;\r\n  let coords: number[][] = [];\r\n  let indices: number[][] = [];\r\n\r\n  let drawBatch = () => {\r\n    let arrays = {\r\n      a_coord: {numComponents: 2, data: [].concat.apply([], coords)},\r\n      indices: {numComponents: 3, data: [].concat.apply([], indices)}\r\n    };\r\n    coords = indices = [];\r\n    let bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);\r\n    twgl.setBuffersAndAttributes(gl, debugProgram, bufferInfo);\r\n    twgl.drawBufferInfo(gl, gl.TRIANGLES, bufferInfo);\r\n  }\r\n\r\n  for (let entity of ces.getEntities(isCollidable).sort((a, b) => (a.position.z || 0) - (b.position.z || 0))) {\r\n    let corners = getCorners(entity);\r\n    for (let poly of corners) {\r\n      coords.push([].concat.apply([], poly));\r\n      let polyIndices: number[] = [];\r\n      for (let i = 2; i < poly.length; i++) {\r\n        polyIndices = polyIndices.concat([indexOffset + i, indexOffset, indexOffset + i - 1])\r\n      }\r\n      indices.push(polyIndices);\r\n      indexOffset += poly.length;\r\n    }\r\n  }\r\n  drawBatch();\r\n}\r\n\r\nexport async function Setup(texturePaths: string[]) {\r\n  let canvas = document.createElement('canvas');\r\n  document.getElementById(\"game\").appendChild(canvas);\r\n  let gl = canvas.getContext('webgl');\r\n  let basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);\r\n  canvas.focus();\r\n\r\n  let textures = await setupTextures(gl, basePath, texturePaths);\r\n  let spriteProgram = await compileProgram(gl, basePath, \"Sprite\");\r\n  let debugProgram = await compileProgram(gl, basePath, \"Debug\");\r\n\r\n  Init.Subscribe(() => {\r\n    gl.useProgram(spriteProgram.program);\r\n\r\n    setCameraUniforms(spriteProgram);\r\n    twgl.setUniforms(spriteProgram, {\r\n      u_texmap: textures.texture,\r\n      u_map_dimensions: textures.size\r\n    });\r\n\r\n    if (debug) {\r\n      gl.useProgram(debugProgram.program);\r\n\r\n      setCameraUniforms(debugProgram);\r\n      twgl.setUniforms(debugProgram, {\r\n        u_color: [1, 0, 0, 0.5]\r\n      });\r\n    }\r\n  });\r\n\r\n  ces.CheckEntity.Subscribe((entity) => {\r\n    if (isRenderable(entity)) {\r\n      entity.color = entity.color || { h: 1, s: 1, v: 1, a: 1, r: 1, g: 1, b: 1 };\r\n    }\r\n    return true;\r\n  });\r\n\r\n  Draw.Subscribe(() => {\r\n    clearCanvas(gl, canvas);\r\n    drawSprites(gl, spriteProgram, textures);\r\n    if (debug) {\r\n      drawDebug(gl, debugProgram);\r\n    }\r\n  });\r\n}\r\n"]}