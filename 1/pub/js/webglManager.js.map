{"version":3,"sources":["webglManager.ts"],"names":[],"mappings":"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","file":"webglManager.js","sourcesContent":["import * as twgl from \"twgl\";\r\n\r\nimport {Update} from \"./animationManager\";\r\n\r\nfunction positionCanvas(canvas: HTMLCanvasElement, gl: WebGLRenderingContext) {\r\n  let size = Math.min(window.innerWidth, window.innerHeight) - 100;\r\n  canvas.style.width = size + \"px\";\r\n  canvas.style.height = size + \"px\";\r\n  canvas.style.marginLeft = -size / 2 + \"px\";\r\n  canvas.style.marginTop = -size / 2 + \"px\";\r\n  gl.viewport(0, 0, size, size);\r\n  return size;\r\n}\r\n\r\nasync function fetchShader(path: string) {\r\n  let result = await fetch(path);\r\n  return await result.text();\r\n}\r\n\r\nasync function packTextures(images: { [id: string]: HTMLImageElement }) {\r\n  let imageArray: {image: HTMLImageElement, id: string}[] = [];\r\n  for (let id in images) {\r\n    imageArray.push({image: images[id], id: id});\r\n  }\r\n  imageArray = imageArray.sort((a, b) => a.image.height - b.image.height);\r\n  let size = 16;\r\n  let correctSize = true;\r\n  do {\r\n    correctSize = true;\r\n    size *= 2;\r\n    let x = 0;\r\n    let y = 0;\r\n    let rowHeight = imageArray[0].image.height;\r\n    for (let imageData of imageArray) {\r\n      let image = imageData.image;\r\n      x += image.width;\r\n      if (x > size) {\r\n        x = 0;\r\n        y += rowHeight;\r\n        if (y + image.height > size) {\r\n          correctSize = false;\r\n          break;\r\n        }\r\n        rowHeight = image.height;\r\n      }\r\n    }\r\n  } while (!correctSize)\r\n\r\n  let canvas = document.createElement('canvas');\r\n  canvas.width = size;\r\n  canvas.height = size;\r\n  let ctx = canvas.getContext('2d');\r\n  let x = 0;\r\n  let y = 0;\r\n  let rowHeight = imageArray[0].image.height;\r\n  let imageLayoutInfo: { [id: string]: number[] } = {};\r\n  for (let imageData of imageArray) {\r\n    let image = imageData.image;\r\n    if (x + image.width > size) {\r\n      x = 0;\r\n      y += rowHeight;\r\n      rowHeight = image.height;\r\n    }\r\n    ctx.drawImage(image, x, y);\r\n    imageLayoutInfo[imageData.id] = [\r\n      x, y,\r\n      x + image.width, y,\r\n      x, y + image.height,\r\n      x + image.width, y,\r\n      x, y + image.height,\r\n      x + image.width, y + image.height\r\n    ];\r\n    x += image.width;\r\n  }\r\n  return {size: size, canvas: canvas, texCoords: imageLayoutInfo};\r\n}\r\n\r\nasync function loadTextures(basePath: string, texturePaths: string[]) {\r\n  let images: { [id: string]: HTMLImageElement } = {};\r\n  for (let path of texturePaths) {\r\n    let imagePath = basePath + \"assets/\" + path;\r\n    let image = new Image();\r\n    let loadedPromise = new Promise((resolve) => {\r\n      let handler = () => {\r\n        resolve();\r\n        image.removeEventListener('load', handler);\r\n      }\r\n      image.addEventListener('load', handler, false);\r\n      image.src = imagePath;\r\n    });\r\n    await loadedPromise;\r\n    images[path] = image;\r\n  }\r\n\r\n  return packTextures(images);\r\n}\r\n\r\n\r\n\r\nexport async function Setup(texturePaths: string[]) {\r\n  let canvas = document.createElement('canvas');\r\n  document.getElementById(\"game\").appendChild(canvas);\r\n  let gl = canvas.getContext('webgl');\r\n  let basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);\r\n  let result = await loadTextures(basePath, texturePaths);\r\n  document.body.appendChild(result.canvas);\r\n\r\n  canvas.focus();\r\n\r\n  let programInfo = twgl.createProgramInfo(gl, [\r\n    await fetchShader(basePath + \"assets/vert.glsl\"),\r\n    await fetchShader(basePath + \"assets/frag.glsl\")\r\n  ]);\r\n\r\n  let texture = twgl.createTexture(gl, {\r\n    src: result.canvas,\r\n    wrap: gl.CLAMP_TO_EDGE,\r\n    mag: gl.NEAREST\r\n  });\r\n\r\n  gl.useProgram(programInfo.program);\r\n  let mapUniforms = {\r\n    u_map_dimensions: result.size\r\n  };\r\n  twgl.setUniforms(programInfo, mapUniforms);\r\n\r\n  Update.Subscribe(() => {\r\n    let displaySize = positionCanvas(canvas, gl);\r\n    gl.clearColor(1, 1, 1, 1);\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    let displayUniforms = {\r\n      u_display_dimensions: displaySize\r\n    };\r\n    twgl.setUniforms(programInfo, displayUniforms);\r\n\r\n    let texCoords = result.texCoords[\"Player.png\"];\r\n    let arrays = {\r\n      a_position: { numComponents: 2, data: [-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1] },\r\n      a_texcoord: { numComponents: 2, data: texCoords }\r\n    };\r\n\r\n    let bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);\r\n    twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);\r\n    twgl.drawBufferInfo(gl, gl.TRIANGLES, bufferInfo);\r\n  });\r\n\r\n}\r\n"]}