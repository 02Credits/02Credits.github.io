{"version":3,"sources":["interpolationManager.ts"],"names":[],"mappings":"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","file":"interpolationManager.js","sourcesContent":["import {CombinedEntity} from \"./entity\";\r\nimport {Update} from \"./animationManager\";\r\nimport * as ces from \"./ces\";\r\n\r\nexport interface Entity {\r\n  interpolated: {\r\n    start: any;\r\n    end: any;\r\n    length: number;\r\n    state?: {\r\n      collapsedStart: any;\r\n      collapsedEnd: any;\r\n      timeStarted: number;\r\n      reverse: boolean;\r\n    }\r\n    reversable?: boolean;\r\n    repeating?: boolean;\r\n    kill?: boolean\r\n  }\r\n}\r\nexport function isInterpolated(entity: CombinedEntity): entity is Entity { return \"interpolated\" in entity; }\r\n\r\nfunction mix(x: number, y: number, a: number) {\r\n  return x * (1 - a) + y * a;\r\n}\r\n\r\nexport function collapseTarget(target: any) {\r\n  let returnTarget: any = {};\r\n  for (let id in target) {\r\n    let value : any = target[id];\r\n    if (!isNaN(value)) {\r\n      returnTarget[id] = value;\r\n    } else if (Array.isArray(value)) {\r\n      let max = Math.max(value[0], value[1]);\r\n      let min = Math.min(value[0], value[1]);\r\n      returnTarget[id] = Math.random() * (max - min) + min;\r\n    } else if (typeof value == \"object\") {\r\n      returnTarget[id] = collapseTarget(value);\r\n    }\r\n  }\r\n  return returnTarget;\r\n}\r\n\r\nfunction initializeState(entity: Entity, time: number) {\r\n  entity.interpolated.state = {\r\n    collapsedStart: collapseTarget(entity.interpolated.start),\r\n    collapsedEnd: collapseTarget(entity.interpolated.end),\r\n    timeStarted: time,\r\n    reverse: false\r\n  };\r\n}\r\n\r\nfunction repeat(entity: Entity, time: number) {\r\n  if (entity.interpolated.reversable) {\r\n    entity.interpolated.state.reverse = !entity.interpolated.state.reverse;\r\n    if (entity.interpolated.state.reverse) {\r\n      entity.interpolated.state.collapsedStart = collapseTarget(entity.interpolated.start);\r\n    } else {\r\n      entity.interpolated.state.collapsedEnd = collapseTarget(entity.interpolated.end);\r\n    }\r\n  } else {\r\n    initializeState(entity, time);\r\n  }\r\n  entity.interpolated.state.timeStarted = time;\r\n}\r\n\r\nfunction interpolate(start: any, end: any, target: any, amount: number) {\r\n  for (let id in start) {\r\n    if (id in end) {\r\n      let startValue = start[id];\r\n      let endValue = end[id];\r\n      if (!isNaN(startValue) || !isNaN(endValue)) {\r\n        if (!isNaN(startValue) && !isNaN(endValue)) {\r\n          target[id] = mix(startValue, endValue, amount);\r\n        }\r\n      } else {\r\n        interpolate(startValue, endValue, target[id], amount);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction interpolateState(entity: Entity, time: number) {\r\n  let start = entity.interpolated.state.collapsedStart;\r\n  let end = entity.interpolated.state.collapsedEnd;\r\n  let amount = (time - entity.interpolated.state.timeStarted) / entity.interpolated.length;\r\n  amount = entity.interpolated.state.reverse ? 1 - amount : amount;\r\n  interpolate(start, end, entity, amount);\r\n}\r\n\r\nexport function Setup() {\r\n  Update.Subscribe((time) => {\r\n    let interpolatedEntities = ces.GetEntities(isInterpolated);\r\n\r\n    for (let entity of interpolatedEntities) {\r\n      let interpolated = entity.interpolated;\r\n      let state = entity.interpolated.state;\r\n      if (!state) {\r\n        initializeState(entity, time);\r\n      } else {\r\n        if (time - state.timeStarted > interpolated.length) {\r\n          if (interpolated.repeating) {\r\n            repeat(entity, time);\r\n          } else {\r\n            if (interpolated.kill) {\r\n              ces.RemoveEntity(entity);\r\n            }\r\n          }\r\n        } else {\r\n          interpolateState(entity, time);\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n"]}