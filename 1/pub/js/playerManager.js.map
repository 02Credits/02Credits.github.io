{"version":3,"sources":["playerManager.ts"],"names":[],"mappings":"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","file":"playerManager.js","sourcesContent":["import * as input from \"./inputManager\";\r\nimport * as ces from \"./ces\";\r\nimport * as utils from \"./utils\"\r\nimport {Update} from \"./animationManager\";\r\nimport {Entity as RenderedEntity} from \"./webglManager\";\r\nimport {Entity as ChildEntity} from \"./parentManager\";\r\nimport {Entity as MotionEntity} from \"./motionManager\";\r\n\r\nimport {CombinedEntity} from \"./entity\";\r\n\r\nexport interface PlayerEntity extends RenderedEntity, MotionEntity {\r\n  player: {\r\n    stepSpeed: number,\r\n    stepSize: number,\r\n    speed: number,\r\n    walkAnimation?: number\r\n  }\r\n}\r\nexport function isPlayer(entity: CombinedEntity): entity is PlayerEntity { return \"player\" in entity; };\r\n\r\nexport interface FootEntity extends RenderedEntity, ChildEntity {\r\n  foot: boolean\r\n}\r\nexport function isFoot(entity: CombinedEntity): entity is FootEntity { return \"foot\" in entity; }\r\n\r\nexport interface PlayerParticle extends RenderedEntity, MotionEntity {\r\n  playerParticle: true\r\n}\r\nexport function isPlayerParticle(entity: CombinedEntity): entity is PlayerParticle { return \"playerParticle\" in entity; }\r\n\r\nexport type Entity = PlayerEntity | FootEntity | PlayerParticle;\r\n\r\nfunction updateFeet(playerEntity: PlayerEntity) {\r\n  var scale = 1;\r\n  if (\"scale\" in playerEntity) {\r\n    scale = playerEntity.scale;\r\n  }\r\n\r\n  var feet = ces.getEntities(isFoot);\r\n  for (let entity of feet) {\r\n    entity.child.relativePosition.y =\r\n      Math.sin(playerEntity.player.walkAnimation) * // Move steps by sin wave\r\n      playerEntity.player.stepSize *                // Account for settings\r\n      playerEntity.player.speed *                   // Step faster as you walk faster\r\n      entity.child.relativePosition.x *             // Account for which foot and scale a bit\r\n      scale\r\n  }\r\n}\r\n\r\nfunction updatePlayer(entity: PlayerEntity) {\r\n  let delta = {x: 0, y: 0, z: 0};\r\n  if (input.KeyDown(\"a\")) {\r\n    delta.x -=  10;\r\n  }\r\n  if (input.KeyDown(\"d\")) {\r\n    delta.x += 10;\r\n  }\r\n  if (input.KeyDown(\"w\")) {\r\n    delta.y += 10;\r\n  }\r\n  if (input.KeyDown(\"s\")) {\r\n    delta.y -= 10;\r\n  }\r\n\r\n  entity.rotation = utils.xyAngle(entity.velocity) + Math.PI / 2;\r\n  let length = utils.length(delta);\r\n  if (length != 0) {\r\n    delta = utils.shrink(delta, length);\r\n  }\r\n  entity.velocity = utils.sum(entity.velocity, utils.scale(delta, 0.1));\r\n\r\n  var playerSpeed = utils.length(entity.velocity);\r\n  entity.player.speed = playerSpeed;\r\n  entity.player.walkAnimation += playerSpeed * entity.player.stepSpeed;\r\n}\r\n\r\nfunction updatePlayerParticle(entity: PlayerParticle) {\r\n  let playerEntities = ces.getEntities(isPlayer)\r\n  let target: utils.Point;\r\n  if (playerEntities.length != 0 && playerEntities.length == 0) {\r\n    let playerEntity = playerEntities[0];\r\n    target = playerEntity.position;\r\n  } else {\r\n    target = input.MouseState().position;\r\n  }\r\n  entity.velocity = utils.sum(utils.scale(utils.normalize(utils.sub(target, entity.position)), 0.1), entity.velocity);\r\n}\r\n\r\nexport function setup() {\r\n  ces.EntityAdded.Subscribe((entity) => {\r\n    if (isPlayer(entity)) {\r\n      entity.velocity = {x: 0, y: 0, z: 0};\r\n      entity.player.walkAnimation = 0;\r\n    }\r\n    if (isPlayerParticle(entity)) {\r\n      entity.velocity = {x: 0, y: 0, z: 0};\r\n    }\r\n  });\r\n\r\n  Update.Subscribe(() => {\r\n    for (let entity of ces.getEntities(isPlayer)) {\r\n      updatePlayer(entity);\r\n      updateFeet(entity);\r\n    }\r\n\r\n    for (let entity of ces.getEntities(isPlayerParticle)) {\r\n      updatePlayerParticle(entity);\r\n    }\r\n  });\r\n}\r\n"]}