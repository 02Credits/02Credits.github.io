{"version":3,"sources":["playerManager.ts"],"names":[],"mappings":"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","file":"playerManager.js","sourcesContent":["import * as input from \"./inputManager\";\r\nimport * as ces from \"./ces\";\r\nimport * as utils from \"./utils\"\r\nimport ObjectPool from \"./objectPool\";\r\nimport {Update} from \"./animationManager\";\r\nimport {Entity as RenderedEntity} from \"./webglManager\";\r\nimport {Entity as ChildEntity} from \"./parentManager\";\r\nimport {Entity as MotionEntity} from \"./motionManager\";\r\n\r\nimport {CombinedEntity} from \"./entity\";\r\n\r\nexport interface PlayerEntity extends RenderedEntity, MotionEntity {\r\n  player: {\r\n    particleCount: number,\r\n    stepSpeed: number,\r\n    stepSize: number,\r\n    dashLength: number,\r\n    particleBase: string,\r\n    footBase: string,\r\n    speed?: number,\r\n    walkAnimation?: number,\r\n    dashStartTime?: number,\r\n    lastDashed?: number,\r\n    pool?: ObjectPool<PlayerParticle>\r\n  },\r\n  enabled?: boolean\r\n}\r\nexport function isPlayer(entity: CombinedEntity): entity is PlayerEntity { return \"player\" in entity; };\r\n\r\nexport interface FootEntity extends RenderedEntity, ChildEntity {\r\n  foot: boolean\r\n}\r\nexport function isFoot(entity: CombinedEntity): entity is FootEntity { return \"foot\" in entity; }\r\n\r\nexport interface PlayerParticle extends RenderedEntity, MotionEntity {\r\n  playerParticle: boolean\r\n}\r\nexport function isPlayerParticle(entity: CombinedEntity): entity is PlayerParticle { return \"playerParticle\" in entity; }\r\n\r\nexport type Entity = PlayerEntity | FootEntity | PlayerParticle;\r\n\r\nfunction updateFeet(playerEntity: PlayerEntity) {\r\n  var scale = 1;\r\n  if (\"scale\" in playerEntity) {\r\n    scale = playerEntity.scale;\r\n  }\r\n\r\n  var feet = ces.getEntities(isFoot);\r\n  for (let entity of feet) {\r\n    entity.child.relativePosition.y =\r\n      Math.sin(playerEntity.player.walkAnimation) * // Move steps by sin wave\r\n      playerEntity.player.stepSize *                // Account for settings\r\n      playerEntity.player.speed *                   // Step faster as you walk faster\r\n      entity.child.relativePosition.x *             // Account for which foot and scale a bit\r\n      scale;\r\n  }\r\n}\r\n\r\nfunction updatePlayer(entity: PlayerEntity, time: number) {\r\n  let mouseState = input.MouseState();\r\n  if (\"enabled\" in entity && !entity.enabled) {\r\n    let particles = ces.getEntities(isPlayerParticle);\r\n    let effectingParticles: PlayerParticle[];\r\n    if (time - entity.player.dashStartTime > entity.player.dashLength) {\r\n      effectingParticles = particles;\r\n    } else {\r\n      let closeParticles = particles.filter(p => utils.length(utils.sub(p.position, mouseState.position)) < entity.dimensions.x / 2);\r\n      if (closeParticles.length > 0) {\r\n        effectingParticles = closeParticles;\r\n      }\r\n    }\r\n\r\n    if (effectingParticles) {\r\n      entity.position = utils.sum(\r\n        {x: 0, y: 0, z: entity.position.z},\r\n        utils.flatten(utils.average(effectingParticles.map(p => p.position)))\r\n      );\r\n      entity.velocity = utils.flatten(utils.average(effectingParticles.map(p => p.velocity)));\r\n      entity.player.lastDashed = time;\r\n      entity.enabled = true;\r\n    }\r\n  } else {\r\n    let strengthLevel = (entity.player.particleCount - 5) / 25;\r\n    if (mouseState.mouseButtons.left && (time - entity.player.lastDashed) > (1 - strengthLevel) * 1.5) {\r\n      for (let i = 0; i < entity.player.particleCount; i++) {\r\n        let particle = entity.player.pool.New();\r\n        particle.velocity = utils.scale(utils.normalize({x: Math.random() - 0.5, y: Math.random() - 0.5, z: 0}), Math.random() + 0.5);\r\n        particle.position = entity.position;\r\n        ces.addEntity(particle);\r\n      }\r\n      entity.enabled = false;\r\n      entity.player.dashStartTime = time;\r\n    } else {\r\n      let delta = {x: 0, y: 0, z: 0};\r\n      if (input.KeyDown(\"a\")) {\r\n        delta.x -=  10;\r\n      }\r\n      if (input.KeyDown(\"d\")) {\r\n        delta.x += 10;\r\n      }\r\n      if (input.KeyDown(\"w\")) {\r\n        delta.y += 10;\r\n      }\r\n      if (input.KeyDown(\"s\")) {\r\n        delta.y -= 10;\r\n      }\r\n\r\n      entity.rotation = utils.xyAngle(entity.velocity) + Math.PI / 2;\r\n      let length = utils.length(delta);\r\n      if (length != 0) {\r\n        delta = utils.shrink(delta, length);\r\n      }\r\n      entity.velocity = utils.sum(entity.velocity, utils.scale(delta, 0.1));\r\n\r\n      var playerSpeed = utils.length(entity.velocity);\r\n      entity.player.speed = playerSpeed;\r\n      entity.player.walkAnimation += playerSpeed * entity.player.stepSpeed;\r\n    }\r\n  }\r\n}\r\n\r\nfunction updatePlayerParticle(entity: PlayerParticle) {\r\n  let mouseState = input.MouseState();\r\n  let playerEntities = ces.getEntities(isPlayer)\r\n  let target: utils.Point;\r\n  if (playerEntities.length != 0) {\r\n    let playerEntity = playerEntities[0];\r\n    target = playerEntity.position;\r\n    if (utils.length(utils.sub(entity.position, playerEntity.position)) < playerEntity.dimensions.x / 2) {\r\n      ces.removeEntity(entity);\r\n      playerEntity.player.pool.Free(entity);\r\n    }\r\n  } else {\r\n    target = mouseState.position;\r\n  }\r\n  entity.velocity = utils.sum(utils.scale(utils.normalize(utils.sub(target, entity.position)), 0.1), entity.velocity);\r\n}\r\n\r\nexport function setup() {\r\n  ces.EntityAdded.Subscribe((entity) => {\r\n    if (isPlayer(entity)) {\r\n      entity.velocity = {x: 0, y: 0, z: 0};\r\n      entity.player.walkAnimation = 0;\r\n      entity.player.lastDashed = -Infinity;\r\n      let particleBase = ces.getEntity(entity.player.particleBase) as any;\r\n      entity.player.pool = new ObjectPool({\r\n          ...particleBase,\r\n        velocity: {x: 0, y: 0, z: 0},\r\n        playerParticle: true,\r\n        enabled: true\r\n      });\r\n      let footBase = ces.getEntity(entity.player.footBase);\r\n      let footPool = new ObjectPool({\r\n          ...footBase,\r\n        enabled: true\r\n      });\r\n      let rightFoot = ces.addEntity({\r\n          ...footPool.New(),\r\n        id: \"rightFoot\",\r\n        child: {\r\n          relativePosition: {\r\n            x: 1\r\n          }\r\n        }\r\n      });\r\n      let leftFoot = ces.addEntity({\r\n          ...footPool.New(),\r\n        id: \"leftFoot\",\r\n        child: {\r\n          relativePosition: {\r\n            x: -1\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  Update.Subscribe((time) => {\r\n    for (let entity of ces.getEntities(isPlayer, true)) {\r\n      updatePlayer(entity, time);\r\n      updateFeet(entity);\r\n    }\r\n\r\n    for (let entity of ces.getEntities(isPlayerParticle)) {\r\n      updatePlayerParticle(entity);\r\n    }\r\n  });\r\n}\r\n"]}